# RBAC 安全加固测试文档

## 📋 测试概述

本文档用于验证基于**角色等级（Role Level）**的安全加固机制，确保低等级用户无法越权操作高等级角色。

## 🔐 安全机制说明

### 1. 角色等级体系

| 等级范围 | 角色类型 | 示例 |
|---------|---------|------|
| 90-100  | 超级管理员 | super_admin (100) |
| 70-89   | 高级管理员 | admin (80) |
| 40-69   | 中级管理员 | department_manager (50) |
| 20-39   | 初级管理员 | project_lead (30) |
| 1-19    | 普通用户 | viewer (10), editor (10) |

### 2. 安全规则

**核心原则**：只能管理**严格低于**自己等级的角色（不包括同级）

- ✅ Level 80 可以管理 Level 50, 30, 10
- ❌ Level 80 **不能**管理 Level 80（同级）
- ❌ Level 80 **不能**管理 Level 100（高等级）
- ✅ Level 100 可以管理所有其他角色

### 3. 保护机制

#### A. 操作层面（写保护）
- 修改角色信息
- 配置角色权限
- 删除角色
- 分配角色给用户
- 撤销用户角色

#### B. 查询层面（读保护） - **行级安全**
- 列表查询：自动过滤高等级角色
- 搜索查询：只返回可管理的角色
- 详情查询：阻止访问高等级角色

## 🧪 测试场景

### 场景 1：查询过滤测试（行级安全）

**目标**：验证低等级用户查询时看不到高等级角色

**准备数据**：
```sql
-- 当前角色列表
SELECT id, name, display_name, level FROM roles ORDER BY level DESC;
-- 结果：
-- 1 | super_admin | 超级管理员 | 100
-- 2 | admin       | 管理员     | 80
-- 3 | editor      | 编辑者     | 10
-- 4 | viewer      | 查看者     | 10
```

**测试步骤**：

#### 1.1 以超级管理员登录（Level 100）
```bash
# 登录获取token
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 查询角色列表
curl -X GET http://localhost:8080/api/v1/roles/search \
  -H "Authorization: Bearer <token>"
```

**预期结果**：
- ✅ 可以看到所有 4 个角色（包括自己）
- ✅ 包含：super_admin(100), admin(80), editor(10), viewer(10)

#### 1.2 以普通管理员登录（Level 80）
```bash
# 假设创建一个 Level 80 的测试用户
# 查询角色列表
curl -X GET http://localhost:8080/api/v1/roles/search \
  -H "Authorization: Bearer <level80_token>"
```

**预期结果**：
- ✅ 只能看到 Level < 80 的角色
- ✅ 包含：editor(10), viewer(10)
- ❌ **看不到**：super_admin(100), admin(80)

#### 1.3 以普通用户登录（Level 10）
```bash
# 查询角色列表
curl -X GET http://localhost:8080/api/v1/roles/search \
  -H "Authorization: Bearer <level10_token>"
```

**预期结果**：
- ✅ 返回空列表或只能看到 Level < 10 的角色（目前没有）
- ❌ **看不到**任何现有角色

---

### 场景 2：修改角色权限测试

**目标**：验证低等级用户无法修改高等级角色的权限

#### 2.1 Level 80 尝试修改 super_admin(100) 的权限

```bash
curl -X POST http://localhost:8080/api/v1/roles/1/permissions/update \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"permission_ids":[1,2,3],"preview":false}'
```

**预期结果**：
- ❌ 返回 403 Forbidden
- 错误消息：`"权限不足：无法操作等级为 100 的角色（您的等级为 80），只能管理比您等级低的角色"`

#### 2.2 Level 80 尝试修改 editor(10) 的权限

```bash
curl -X POST http://localhost:8080/api/v1/roles/3/permissions/update \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"permission_ids":[1,2,3],"preview":false}'
```

**预期结果**：
- ✅ 成功修改
- 返回 200 OK

---

### 场景 3：删除角色测试

#### 3.1 Level 80 尝试删除 super_admin(100)

```bash
curl -X DELETE http://localhost:8080/api/v1/roles/1 \
  -H "Authorization: Bearer <level80_token>"
```

**预期结果**：
- ❌ 返回 403 Forbidden
- 错误消息：`"权限不足：无法操作等级为 100 的角色..."`

#### 3.2 Level 10 尝试删除任何角色

```bash
curl -X DELETE http://localhost:8080/api/v1/roles/3 \
  -H "Authorization: Bearer <level10_token>"
```

**预期结果**：
- ❌ 返回 403 Forbidden

---

### 场景 4：分配角色给用户测试

#### 4.1 Level 80 尝试给用户分配 super_admin(100)

```bash
curl -X POST http://localhost:8080/api/v1/user-roles/user/2/roles \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"role_ids":[1],"domain":"default"}'
```

**预期结果**：
- ❌ 返回 403 Forbidden
- 错误消息：`"权限不足：无法分配等级为 100 的角色 '超级管理员'（您的等级为 80）..."`

#### 4.2 Level 80 给用户分配 editor(10)

```bash
curl -X POST http://localhost:8080/api/v1/user-roles/user/2/roles \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"role_ids":[3],"domain":"default"}'
```

**预期结果**：
- ✅ 成功分配
- 返回 200 OK

---

### 场景 5：同级用户互相操作测试

#### 5.1 创建两个 Level 50 的用户

```sql
-- 创建角色
INSERT INTO roles (name, display_name, domain, level) 
VALUES ('manager1', '经理A', 'default', 50);

INSERT INTO roles (name, display_name, domain, level) 
VALUES ('manager2', '经理B', 'default', 50);

-- 分配给不同用户
-- user_id=3 拥有 manager1(50)
-- user_id=4 拥有 manager2(50)
```

#### 5.2 Level 50 用户尝试修改另一个 Level 50 角色

```bash
# user_id=3 (Level 50) 尝试修改 manager2(Level 50)
curl -X PUT http://localhost:8080/api/v1/roles/6 \
  -H "Authorization: Bearer <user3_token>" \
  -H "Content-Type: application/json" \
  -d '{"display_name":"修改后的名称"}'
```

**预期结果**：
- ❌ 返回 403 Forbidden
- 说明：等级必须**严格高于**才能操作，同级不可互相修改

---

## 📊 测试报告模板

### 测试环境
- 系统版本：v1.0.0
- 测试时间：2025-10-17
- 测试人员：[姓名]

### 测试结果

| 场景 | 测试项 | 预期结果 | 实际结果 | 状态 |
|-----|--------|---------|---------|------|
| 1.1 | Level 100 查询所有角色 | 看到 4 个角色 | ✅ | PASS |
| 1.2 | Level 80 查询角色 | 只看到 Level < 80 | ✅ | PASS |
| 1.3 | Level 10 查询角色 | 空列表 | ✅ | PASS |
| 2.1 | Level 80 修改 super_admin | 403 Forbidden | ✅ | PASS |
| 2.2 | Level 80 修改 editor | 200 OK | ✅ | PASS |
| 3.1 | Level 80 删除 super_admin | 403 Forbidden | ✅ | PASS |
| 4.1 | Level 80 分配 super_admin | 403 Forbidden | ✅ | PASS |
| 4.2 | Level 80 分配 editor | 200 OK | ✅ | PASS |
| 5.2 | 同级用户互相修改 | 403 Forbidden | ✅ | PASS |

---

## 🛡️ 安全最佳实践

### 1. 永远不要信任前端验证
- 前端UI禁用按钮只是用户体验优化
- 后端必须始终验证权限
- **纵深防御**：前端 + 后端双重检查

### 2. 最小权限原则
- 默认拒绝：如果无法获取用户等级，返回空列表
- 显式授权：必须明确检查等级后才允许操作

### 3. 审计日志
- 记录所有权限验证失败的尝试
- 监控异常的越权操作

### 4. 定期审查
- 定期检查用户角色分配
- 审查高等级角色的操作日志
- 确保没有权限泄漏

---

## 🔧 故障排查

### 问题1：查询仍然返回高等级角色

**可能原因**：
- Handler 层未使用 `ListRolesFiltered` 方法
- 用户ID获取失败，走了兜底逻辑

**解决方法**：
```go
// 检查 Handler 是否使用了正确的方法
roles, err = h.rbacService.ListRolesFiltered(c.Request().Context(), operatorID, domain, pagination)
```

### 问题2：修改操作未被阻止

**可能原因**：
- Handler 层缺少等级检查
- 中间件未正确设置 user_id

**解决方法**：
```go
// 在 Handler 开头添加检查
if operatorID, ok := c.Get("user_id").(uint); ok && operatorID > 0 {
    if err := h.rbacService.CheckRoleLevelPermission(...); err != nil {
        return errors.New(errors.ErrForbidden, err.Error())
    }
}
```

---

## 📚 参考资料

- **Casbin RBAC**: https://casbin.org/docs/rbac
- **Apache Ranger Row-Level Filtering**: https://ranger.apache.org/
- **PostgreSQL Row Level Security**: https://www.postgresql.org/docs/current/ddl-rowsecurity.html
- **OWASP Access Control**: https://owasp.org/www-community/Access_Control

---

## 总结

通过实施**角色等级 + 行级安全**机制，我们实现了：

1. ✅ **操作保护**：低等级用户无法修改/删除高等级角色
2. ✅ **查询隔离**：低等级用户查询时看不到高等级角色
3. ✅ **权限分配控制**：无法给用户分配高于自己的角色
4. ✅ **防同级攻击**：同等级用户无法互相修改

这种设计符合业界最佳实践，有效防止了权限升级攻击。
