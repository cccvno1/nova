# RBAC å®‰å…¨åŠ å›ºæµ‹è¯•æ–‡æ¡£

## ğŸ“‹ æµ‹è¯•æ¦‚è¿°

æœ¬æ–‡æ¡£ç”¨äºéªŒè¯åŸºäº**è§’è‰²ç­‰çº§ï¼ˆRole Levelï¼‰**çš„å®‰å…¨åŠ å›ºæœºåˆ¶ï¼Œç¡®ä¿ä½ç­‰çº§ç”¨æˆ·æ— æ³•è¶Šæƒæ“ä½œé«˜ç­‰çº§è§’è‰²ã€‚

## ğŸ” å®‰å…¨æœºåˆ¶è¯´æ˜

### 1. è§’è‰²ç­‰çº§ä½“ç³»

| ç­‰çº§èŒƒå›´ | è§’è‰²ç±»å‹ | ç¤ºä¾‹ |
|---------|---------|------|
| 90-100  | è¶…çº§ç®¡ç†å‘˜ | super_admin (100) |
| 70-89   | é«˜çº§ç®¡ç†å‘˜ | admin (80) |
| 40-69   | ä¸­çº§ç®¡ç†å‘˜ | department_manager (50) |
| 20-39   | åˆçº§ç®¡ç†å‘˜ | project_lead (30) |
| 1-19    | æ™®é€šç”¨æˆ· | viewer (10), editor (10) |

### 2. å®‰å…¨è§„åˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼šåªèƒ½ç®¡ç†**ä¸¥æ ¼ä½äº**è‡ªå·±ç­‰çº§çš„è§’è‰²ï¼ˆä¸åŒ…æ‹¬åŒçº§ï¼‰

- âœ… Level 80 å¯ä»¥ç®¡ç† Level 50, 30, 10
- âŒ Level 80 **ä¸èƒ½**ç®¡ç† Level 80ï¼ˆåŒçº§ï¼‰
- âŒ Level 80 **ä¸èƒ½**ç®¡ç† Level 100ï¼ˆé«˜ç­‰çº§ï¼‰
- âœ… Level 100 å¯ä»¥ç®¡ç†æ‰€æœ‰å…¶ä»–è§’è‰²

### 3. ä¿æŠ¤æœºåˆ¶

#### A. æ“ä½œå±‚é¢ï¼ˆå†™ä¿æŠ¤ï¼‰
- ä¿®æ”¹è§’è‰²ä¿¡æ¯
- é…ç½®è§’è‰²æƒé™
- åˆ é™¤è§’è‰²
- åˆ†é…è§’è‰²ç»™ç”¨æˆ·
- æ’¤é”€ç”¨æˆ·è§’è‰²

#### B. æŸ¥è¯¢å±‚é¢ï¼ˆè¯»ä¿æŠ¤ï¼‰ - **è¡Œçº§å®‰å…¨**
- åˆ—è¡¨æŸ¥è¯¢ï¼šè‡ªåŠ¨è¿‡æ»¤é«˜ç­‰çº§è§’è‰²
- æœç´¢æŸ¥è¯¢ï¼šåªè¿”å›å¯ç®¡ç†çš„è§’è‰²
- è¯¦æƒ…æŸ¥è¯¢ï¼šé˜»æ­¢è®¿é—®é«˜ç­‰çº§è§’è‰²

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šæŸ¥è¯¢è¿‡æ»¤æµ‹è¯•ï¼ˆè¡Œçº§å®‰å…¨ï¼‰

**ç›®æ ‡**ï¼šéªŒè¯ä½ç­‰çº§ç”¨æˆ·æŸ¥è¯¢æ—¶çœ‹ä¸åˆ°é«˜ç­‰çº§è§’è‰²

**å‡†å¤‡æ•°æ®**ï¼š
```sql
-- å½“å‰è§’è‰²åˆ—è¡¨
SELECT id, name, display_name, level FROM roles ORDER BY level DESC;
-- ç»“æœï¼š
-- 1 | super_admin | è¶…çº§ç®¡ç†å‘˜ | 100
-- 2 | admin       | ç®¡ç†å‘˜     | 80
-- 3 | editor      | ç¼–è¾‘è€…     | 10
-- 4 | viewer      | æŸ¥çœ‹è€…     | 10
```

**æµ‹è¯•æ­¥éª¤**ï¼š

#### 1.1 ä»¥è¶…çº§ç®¡ç†å‘˜ç™»å½•ï¼ˆLevel 100ï¼‰
```bash
# ç™»å½•è·å–token
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# æŸ¥è¯¢è§’è‰²åˆ—è¡¨
curl -X GET http://localhost:8080/api/v1/roles/search \
  -H "Authorization: Bearer <token>"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¯ä»¥çœ‹åˆ°æ‰€æœ‰ 4 ä¸ªè§’è‰²ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
- âœ… åŒ…å«ï¼šsuper_admin(100), admin(80), editor(10), viewer(10)

#### 1.2 ä»¥æ™®é€šç®¡ç†å‘˜ç™»å½•ï¼ˆLevel 80ï¼‰
```bash
# å‡è®¾åˆ›å»ºä¸€ä¸ª Level 80 çš„æµ‹è¯•ç”¨æˆ·
# æŸ¥è¯¢è§’è‰²åˆ—è¡¨
curl -X GET http://localhost:8080/api/v1/roles/search \
  -H "Authorization: Bearer <level80_token>"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… åªèƒ½çœ‹åˆ° Level < 80 çš„è§’è‰²
- âœ… åŒ…å«ï¼šeditor(10), viewer(10)
- âŒ **çœ‹ä¸åˆ°**ï¼šsuper_admin(100), admin(80)

#### 1.3 ä»¥æ™®é€šç”¨æˆ·ç™»å½•ï¼ˆLevel 10ï¼‰
```bash
# æŸ¥è¯¢è§’è‰²åˆ—è¡¨
curl -X GET http://localhost:8080/api/v1/roles/search \
  -H "Authorization: Bearer <level10_token>"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¿”å›ç©ºåˆ—è¡¨æˆ–åªèƒ½çœ‹åˆ° Level < 10 çš„è§’è‰²ï¼ˆç›®å‰æ²¡æœ‰ï¼‰
- âŒ **çœ‹ä¸åˆ°**ä»»ä½•ç°æœ‰è§’è‰²

---

### åœºæ™¯ 2ï¼šä¿®æ”¹è§’è‰²æƒé™æµ‹è¯•

**ç›®æ ‡**ï¼šéªŒè¯ä½ç­‰çº§ç”¨æˆ·æ— æ³•ä¿®æ”¹é«˜ç­‰çº§è§’è‰²çš„æƒé™

#### 2.1 Level 80 å°è¯•ä¿®æ”¹ super_admin(100) çš„æƒé™

```bash
curl -X POST http://localhost:8080/api/v1/roles/1/permissions/update \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"permission_ids":[1,2,3],"preview":false}'
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ è¿”å› 403 Forbidden
- é”™è¯¯æ¶ˆæ¯ï¼š`"æƒé™ä¸è¶³ï¼šæ— æ³•æ“ä½œç­‰çº§ä¸º 100 çš„è§’è‰²ï¼ˆæ‚¨çš„ç­‰çº§ä¸º 80ï¼‰ï¼Œåªèƒ½ç®¡ç†æ¯”æ‚¨ç­‰çº§ä½çš„è§’è‰²"`

#### 2.2 Level 80 å°è¯•ä¿®æ”¹ editor(10) çš„æƒé™

```bash
curl -X POST http://localhost:8080/api/v1/roles/3/permissions/update \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"permission_ids":[1,2,3],"preview":false}'
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æˆåŠŸä¿®æ”¹
- è¿”å› 200 OK

---

### åœºæ™¯ 3ï¼šåˆ é™¤è§’è‰²æµ‹è¯•

#### 3.1 Level 80 å°è¯•åˆ é™¤ super_admin(100)

```bash
curl -X DELETE http://localhost:8080/api/v1/roles/1 \
  -H "Authorization: Bearer <level80_token>"
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ è¿”å› 403 Forbidden
- é”™è¯¯æ¶ˆæ¯ï¼š`"æƒé™ä¸è¶³ï¼šæ— æ³•æ“ä½œç­‰çº§ä¸º 100 çš„è§’è‰²..."`

#### 3.2 Level 10 å°è¯•åˆ é™¤ä»»ä½•è§’è‰²

```bash
curl -X DELETE http://localhost:8080/api/v1/roles/3 \
  -H "Authorization: Bearer <level10_token>"
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ è¿”å› 403 Forbidden

---

### åœºæ™¯ 4ï¼šåˆ†é…è§’è‰²ç»™ç”¨æˆ·æµ‹è¯•

#### 4.1 Level 80 å°è¯•ç»™ç”¨æˆ·åˆ†é… super_admin(100)

```bash
curl -X POST http://localhost:8080/api/v1/user-roles/user/2/roles \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"role_ids":[1],"domain":"default"}'
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ è¿”å› 403 Forbidden
- é”™è¯¯æ¶ˆæ¯ï¼š`"æƒé™ä¸è¶³ï¼šæ— æ³•åˆ†é…ç­‰çº§ä¸º 100 çš„è§’è‰² 'è¶…çº§ç®¡ç†å‘˜'ï¼ˆæ‚¨çš„ç­‰çº§ä¸º 80ï¼‰..."`

#### 4.2 Level 80 ç»™ç”¨æˆ·åˆ†é… editor(10)

```bash
curl -X POST http://localhost:8080/api/v1/user-roles/user/2/roles \
  -H "Authorization: Bearer <level80_token>" \
  -H "Content-Type: application/json" \
  -d '{"role_ids":[3],"domain":"default"}'
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æˆåŠŸåˆ†é…
- è¿”å› 200 OK

---

### åœºæ™¯ 5ï¼šåŒçº§ç”¨æˆ·äº’ç›¸æ“ä½œæµ‹è¯•

#### 5.1 åˆ›å»ºä¸¤ä¸ª Level 50 çš„ç”¨æˆ·

```sql
-- åˆ›å»ºè§’è‰²
INSERT INTO roles (name, display_name, domain, level) 
VALUES ('manager1', 'ç»ç†A', 'default', 50);

INSERT INTO roles (name, display_name, domain, level) 
VALUES ('manager2', 'ç»ç†B', 'default', 50);

-- åˆ†é…ç»™ä¸åŒç”¨æˆ·
-- user_id=3 æ‹¥æœ‰ manager1(50)
-- user_id=4 æ‹¥æœ‰ manager2(50)
```

#### 5.2 Level 50 ç”¨æˆ·å°è¯•ä¿®æ”¹å¦ä¸€ä¸ª Level 50 è§’è‰²

```bash
# user_id=3 (Level 50) å°è¯•ä¿®æ”¹ manager2(Level 50)
curl -X PUT http://localhost:8080/api/v1/roles/6 \
  -H "Authorization: Bearer <user3_token>" \
  -H "Content-Type: application/json" \
  -d '{"display_name":"ä¿®æ”¹åçš„åç§°"}'
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ è¿”å› 403 Forbidden
- è¯´æ˜ï¼šç­‰çº§å¿…é¡»**ä¸¥æ ¼é«˜äº**æ‰èƒ½æ“ä½œï¼ŒåŒçº§ä¸å¯äº’ç›¸ä¿®æ”¹

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### æµ‹è¯•ç¯å¢ƒ
- ç³»ç»Ÿç‰ˆæœ¬ï¼šv1.0.0
- æµ‹è¯•æ—¶é—´ï¼š2025-10-17
- æµ‹è¯•äººå‘˜ï¼š[å§“å]

### æµ‹è¯•ç»“æœ

| åœºæ™¯ | æµ‹è¯•é¡¹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|-----|--------|---------|---------|------|
| 1.1 | Level 100 æŸ¥è¯¢æ‰€æœ‰è§’è‰² | çœ‹åˆ° 4 ä¸ªè§’è‰² | âœ… | PASS |
| 1.2 | Level 80 æŸ¥è¯¢è§’è‰² | åªçœ‹åˆ° Level < 80 | âœ… | PASS |
| 1.3 | Level 10 æŸ¥è¯¢è§’è‰² | ç©ºåˆ—è¡¨ | âœ… | PASS |
| 2.1 | Level 80 ä¿®æ”¹ super_admin | 403 Forbidden | âœ… | PASS |
| 2.2 | Level 80 ä¿®æ”¹ editor | 200 OK | âœ… | PASS |
| 3.1 | Level 80 åˆ é™¤ super_admin | 403 Forbidden | âœ… | PASS |
| 4.1 | Level 80 åˆ†é… super_admin | 403 Forbidden | âœ… | PASS |
| 4.2 | Level 80 åˆ†é… editor | 200 OK | âœ… | PASS |
| 5.2 | åŒçº§ç”¨æˆ·äº’ç›¸ä¿®æ”¹ | 403 Forbidden | âœ… | PASS |

---

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. æ°¸è¿œä¸è¦ä¿¡ä»»å‰ç«¯éªŒè¯
- å‰ç«¯UIç¦ç”¨æŒ‰é’®åªæ˜¯ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- åç«¯å¿…é¡»å§‹ç»ˆéªŒè¯æƒé™
- **çºµæ·±é˜²å¾¡**ï¼šå‰ç«¯ + åç«¯åŒé‡æ£€æŸ¥

### 2. æœ€å°æƒé™åŸåˆ™
- é»˜è®¤æ‹’ç»ï¼šå¦‚æœæ— æ³•è·å–ç”¨æˆ·ç­‰çº§ï¼Œè¿”å›ç©ºåˆ—è¡¨
- æ˜¾å¼æˆæƒï¼šå¿…é¡»æ˜ç¡®æ£€æŸ¥ç­‰çº§åæ‰å…è®¸æ“ä½œ

### 3. å®¡è®¡æ—¥å¿—
- è®°å½•æ‰€æœ‰æƒé™éªŒè¯å¤±è´¥çš„å°è¯•
- ç›‘æ§å¼‚å¸¸çš„è¶Šæƒæ“ä½œ

### 4. å®šæœŸå®¡æŸ¥
- å®šæœŸæ£€æŸ¥ç”¨æˆ·è§’è‰²åˆ†é…
- å®¡æŸ¥é«˜ç­‰çº§è§’è‰²çš„æ“ä½œæ—¥å¿—
- ç¡®ä¿æ²¡æœ‰æƒé™æ³„æ¼

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæŸ¥è¯¢ä»ç„¶è¿”å›é«˜ç­‰çº§è§’è‰²

**å¯èƒ½åŸå› **ï¼š
- Handler å±‚æœªä½¿ç”¨ `ListRolesFiltered` æ–¹æ³•
- ç”¨æˆ·IDè·å–å¤±è´¥ï¼Œèµ°äº†å…œåº•é€»è¾‘

**è§£å†³æ–¹æ³•**ï¼š
```go
// æ£€æŸ¥ Handler æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„æ–¹æ³•
roles, err = h.rbacService.ListRolesFiltered(c.Request().Context(), operatorID, domain, pagination)
```

### é—®é¢˜2ï¼šä¿®æ”¹æ“ä½œæœªè¢«é˜»æ­¢

**å¯èƒ½åŸå› **ï¼š
- Handler å±‚ç¼ºå°‘ç­‰çº§æ£€æŸ¥
- ä¸­é—´ä»¶æœªæ­£ç¡®è®¾ç½® user_id

**è§£å†³æ–¹æ³•**ï¼š
```go
// åœ¨ Handler å¼€å¤´æ·»åŠ æ£€æŸ¥
if operatorID, ok := c.Get("user_id").(uint); ok && operatorID > 0 {
    if err := h.rbacService.CheckRoleLevelPermission(...); err != nil {
        return errors.New(errors.ErrForbidden, err.Error())
    }
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **Casbin RBAC**: https://casbin.org/docs/rbac
- **Apache Ranger Row-Level Filtering**: https://ranger.apache.org/
- **PostgreSQL Row Level Security**: https://www.postgresql.org/docs/current/ddl-rowsecurity.html
- **OWASP Access Control**: https://owasp.org/www-community/Access_Control

---

## æ€»ç»“

é€šè¿‡å®æ–½**è§’è‰²ç­‰çº§ + è¡Œçº§å®‰å…¨**æœºåˆ¶ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. âœ… **æ“ä½œä¿æŠ¤**ï¼šä½ç­‰çº§ç”¨æˆ·æ— æ³•ä¿®æ”¹/åˆ é™¤é«˜ç­‰çº§è§’è‰²
2. âœ… **æŸ¥è¯¢éš”ç¦»**ï¼šä½ç­‰çº§ç”¨æˆ·æŸ¥è¯¢æ—¶çœ‹ä¸åˆ°é«˜ç­‰çº§è§’è‰²
3. âœ… **æƒé™åˆ†é…æ§åˆ¶**ï¼šæ— æ³•ç»™ç”¨æˆ·åˆ†é…é«˜äºè‡ªå·±çš„è§’è‰²
4. âœ… **é˜²åŒçº§æ”»å‡»**ï¼šåŒç­‰çº§ç”¨æˆ·æ— æ³•äº’ç›¸ä¿®æ”¹

è¿™ç§è®¾è®¡ç¬¦åˆä¸šç•Œæœ€ä½³å®è·µï¼Œæœ‰æ•ˆé˜²æ­¢äº†æƒé™å‡çº§æ”»å‡»ã€‚
