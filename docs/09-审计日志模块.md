# 审计日志模块

## 组件概览
- 中间件：`pkg/middleware/audit.go`
- 仓储：`internal/repository/audit_log_repository.go`
- 模型：`internal/model/audit_log.go`
- 接口：`internal/handler/audit_log_handler.go`
- 配置项：`config.audit_log`（`pkg/config/config.go`）

## 中间件机制
- 在 `router.Setup` 中，`auditMiddleware.Handler()` 被挂载到所有需要认证的路由组上。
- 当 `config.audit_log.enabled = true` 时生效；否则直接跳过以减少开销。
- 处理流程：
  1. 判断路径是否命中 `exclude_paths`，命中则放行不记录。
  2. 按需读取请求体和响应体（受 `max_body_size` 限制），支持敏感字段脱敏。
  3. 提取操作信息：根据 HTTP 方法推导 `action`（create/read/update/delete/login/logout），从路径拆解资源和资源 ID。
  4. 获取当前用户（依赖认证中间件在上下文写入 `user_id` / `username`）。
  5. 记录耗时、状态码、错误信息等元数据。
  6. 使用 `auditRepo.Create` 异步写入数据库，不影响主链路。

### 脱敏策略
- `sensitive_fields` 配置指定需要掩码的 JSON 字段，记录体被解析后替换为 `***MASKED***`。
- 如数据不是 JSON，则按原文存储，可通过扩展进一步支持结构化脱敏。

## 数据模型
- `audit_logs` 表结构记录用户、动作、资源、请求路径、IP、User-Agent、请求/响应体、状态码、耗时等信息。
- 常量提供标准化资源/动作枚举，可在业务侧统一使用。
- `IsSuccess`、`GetDurationMs` 等方法便于二次处理。

## 仓储能力
- 多种查询方法：
  - 按用户、动作、资源、IP、时间范围等条件分页查询。
  - `Search` 支持组合过滤（用户、动作、资源、方法、路径、状态码、时间区间）。
- 统计接口：
  - `GetActionStats` / `GetUserStats` / `GetResourceStats` 聚合操作次数，支持设定时间范围。
  - `CountByStatus`、`CountByTimeRange` 用于概览成功率与趋势。
- 清理接口：`DeleteBefore` 默认执行软删除（依赖 GORM 的 `DeletedAt`），如需物理删除需改用 `Unscoped()`。

## REST 接口
- `GET /api/v1/audit-logs`：综合列表查询，携带上述过滤参数；默认按时间倒序。
- `GET /api/v1/audit-logs/:id`：查看单条记录详情。
- `GET /api/v1/audit-logs/user/:userId`：获取指定用户的历史操作。
- `GET /api/v1/audit-logs/stats`：返回总数、成功/失败统计、Top 用户/资源/动作。
- `GET /api/v1/audit-logs/stats/actions`：按动作聚合（默认近 24 小时）。
- `GET /api/v1/audit-logs/stats/users`：用户操作 TopN（默认近 7 天，Top10）。
- `GET /api/v1/audit-logs/stats/resources`：资源维度统计（默认近 7 天）。
- `DELETE /api/v1/audit-logs/clean`：清理旧数据，默认保留 90 天，可传 `days` 调整。

## 配置字段
- `enabled`：是否开启审计记录。
- `log_request` / `log_response`：控制是否捕获请求体和响应体。
- `max_body_size`：限制记录体积，避免数据库爆炸。
- `exclude_paths`：无需记录的路径前缀（如健康检查、静态资源）。
- `include_actions`：当前实现未使用（可按需扩展）；留空不影响记录。
- `sensitive_fields`：敏感字段掩码列表，如 `password`、`token`。

## 实战建议
1. **索引优化**：根据实际查询场景调整数据库索引（如常用的 `resource + action` 组合）。
2. **分表归档**：高并发场景下可按月份分表或同步至时序/日志系统（如 Elasticsearch）。
3. **仪表盘**：结合统计接口，在后管展示访问趋势、错误峰值、用户活跃度。
4. **告警联动**：发现异常操作（短时间大量删除、频繁失败登录）时可触发通知。
5. **数据治理**：定期执行 `CleanOldLogs` 或使用 Scheduler 自动归档，满足合规对数据留存的要求。

通过该模块，可在系统中追踪所有关键操作，为安全审计、问题排查提供可靠依据，并支持后续的监控与告警建设。