# 部署与维护

## 环境要求
- **Go 版本**：`go 1.24+`（模块定义于 `go.mod`）。
- **数据库**：PostgreSQL 13+（当前实现仅提供 Postgres 驱动）。
- **缓存/队列**：Redis 6+ 用于限流、Token 黑名单、队列。
- **操作系统**：Linux/Unix 推荐，Windows 亦可（需注意路径配置）。
- **构建工具**：`git`、`make`（可选）、`systemd` 或容器平台用于生产部署。

## 配置管理
1. 复制基础配置：`cp configs/config.yaml configs/config.local.yaml`。
2. 根据环境修改以下要点：
   - `server.host/port/mode`：监听地址与运行模式（`debug`/`release`）。
   - `database`：数据库驱动、连接串、最大连接数。
   - `redis`：主机、密码、库号与连接池设置。
   - `auth.jwt_secret`：生产环境务必替换为高强度随机值。
   - `upload`：本地/云存储参数，生产中推荐放置于持久化卷或对象存储。
   - `queue.enabled`：启用后会自动启动 Worker；如仅单实例可关闭节约资源。
   - `audit_log`：按合规要求调整保留路径、敏感字段掩码、请求体记录开关。
3. 运行时可通过环境变量覆盖配置：`NOVA_DATABASE_HOST=prod-db ... ./nova -config configs/config.local.yaml`。

## 编译与启动
```bash
go mod tidy
go build -o bin/nova ./cmd/server
./bin/nova -config configs/config.local.yaml
```
- 首次启动会执行 `AutoMigrate`，自动创建用户、角色、权限、文件、任务、审计日志等表。确保数据库账号具备建表权限。
- 访问 `http://<host>:<port>/swagger/index.html` 查看 API 文档。
- 健康检查：`GET /api/v1/health`。

## 运行组件
- **JWT 黑名单**：依赖 Redis，程序退出时无需清理，token 自行过期。
- **异步队列**：
  - 默认开启，启动日志中可见 `starting queue workers`。
  - 若需自定义任务，在 `cmd/server/main.go` 注册 handler。
  - 在多实例部署下可单独部署 Worker 进程，只需共享 Redis。
- **定时任务调度器**：`scheduler.NewScheduler()` 默认启动，可在启动逻辑中添加 `AddFunc` / `AddInterval`。
- **审计中间件**：随服务启动，写入数据库；若数据库压力大，可关闭 `log_response` 或缩减 `max_body_size`。

## 部署建议
1. **Systemd 示例**
   ```ini
   [Unit]
   Description=Nova API Server
   After=network.target

   [Service]
   ExecStart=/opt/nova/bin/nova -config /opt/nova/configs/config.prod.yaml
   WorkingDirectory=/opt/nova
   Restart=always
   Environment="NOVA_SERVER_MODE=release"

   [Install]
   WantedBy=multi-user.target
   ```
2. **容器化**：
   - 使用多阶段构建镜像（Go 构建 + distroless 运行）。
   - 将配置与上传目录挂载为外部卷。
   - 通过环境变量注入数据库、Redis 凭据。
3. **负载均衡**：多个实例需共享 Redis、数据库及对象存储。Casbin 策略自动加载可保持权限同步。

## 日志与监控
- 日志配置支持 `json` 与 `text`，输出到 stdout 或文件（滚动策略由 `max_size/max_backups/max_age` 控制）。
- 关键端点：
  - `/api/v1/tasks/stats`：任务队列执行概览。
  - `/api/v1/audit-logs/stats`：审计数据分析。
- 建议接入 Prometheus / Grafana，通过自定义中间件或队列统计暴露指标。

## 维护任务
- **数据库备份**：定期备份 `nova` 库，尤其是 `audit_logs`、`files` 元数据表。
- **审计清理**：调用 `DELETE /api/v1/audit-logs/clean?days=90` 或配合 Scheduler 定期执行。
- **文件清理**：若开启秒传可能存在孤立物理文件，可编写任务比对 `files` 表与实际存储后清理。
- **队列监控**：`queue.enabled` 场景下关注 Redis 列表长度，防止积压。
- **依赖升级**：关注 `go mod tidy` 报告与安全公告，升级后执行回归测试。

## 故障排查
- 检查日志：`logs/app.log` 或 stdout 输出。
- 数据库连接失败：确认网络、防火墙、账号权限；必要时调整连接池大小。
- Redis 连接异常：核对密码、db、sentinel 配置（当前仅支持单机/主从模式）。
- 权限异常：
  - 确认 Casbin 策略表与 `role_permissions` 是否同步。
  - 调用 `CheckUserPermission` 时需确保请求已通过 `Auth` 中间件，让处理器从上下文获取用户 ID。
- 上传失败：
  - 查看 `upload.max_size`、白名单。
  - 确认本地存储路径可写或云凭据有效。

做好上述准备与维护，即可稳定运行 Nova 服务，并根据业务需要弹性扩展异步任务、审计策略及文件存储方案。