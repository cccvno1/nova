# 中间件层

## 全局链路
默认在 `server.New` 中依次挂载：
1. `Recovery`：捕获 panic，返回统一错误响应
2. `Logger`：记录请求方法、URI、状态码、耗时、IP、UA
3. `CORS`：允许常见跨域场景
4. 自定义 `ErrorHandler`：替换 Echo 默认错误输出

## ErrorHandler
- 文件：`pkg/middleware/error.go`
- 处理逻辑：
  - `errors.AppError`：直接返回定义好的业务错误码
  - `echo.HTTPError`：映射到内部错误码体系
  - 验证错误：使用 `validator.FormatValidationError` 生成详情
  - 未知错误：记录日志后返回 `ErrInternalServer`

## Recovery
- 文件：`pkg/middleware/recovery.go`
- 捕获 panic，打印堆栈，返回 500

## Logger
- 文件：`pkg/middleware/logger.go`
- 记录访问日志，方便链路追踪

## CORS
- 文件：`pkg/middleware/cors.go`
- 默认允许所有来源，支持凭证

## 认证中间件
- 文件：`pkg/middleware/auth.go`
- 功能：
  - 校验 `Authorization: Bearer <token>`
  - 验证 JWT 签名及类型（只接受 Access Token）
  - 检查 Token 黑名单与强制下线
  - 将 `user_id`、`username` 写入上下文
- 工具函数：`GetUserID`, `GetUsername`

## 限流中间件
- 文件：`pkg/middleware/ratelimit.go`
- 支持算法：`token_bucket`, `sliding_window`
- 限流维度：`ip`, `user`, `api`
- 响应头：`X-RateLimit-Limit`、`X-RateLimit-Remaining`、`X-RateLimit-Reset`
- 提供快捷方法：`RateLimitByIP`, `RateLimitByUser`, `RateLimitByAPI`

### 使用示例
```go
api := e.Group("/api", middleware.RateLimit(&middleware.RateLimitConfig{
    Enabled:   true,
    Algorithm: "sliding_window",
    Limit:     200,
    Window:    60,
    Dimension: "user",
}))
```

## 权限中间件
- 文件：`pkg/middleware/permission.go`
- 基于 Casbin，按以下元素校验：
  - Subject：用户 ID
  - Domain：默认 `default`，可通过 Header/Query 指定
  - Object：请求路径
  - Action：根据 HTTP 方法映射（GET→read，POST→write 等）
- 扩展：
  - `RequirePermission`：精确控制资源/动作
  - `RequireAnyPermission` / `RequireAllPermissions`
  - `CheckPermission`：在 Handler 内手动校验

## 审计中间件
- 文件：`pkg/middleware/audit.go`
- 关键能力：
  - 排除路径：`config.audit_log.exclude_paths`
  - 捕获请求/响应体并脱敏（JSON 字段替换 `***MASKED***`）
  - 提取用户信息（来自认证中间件）
  - 自动推断动作（create/read/update/delete/login/logout）
  - 异步写入 `audit_logs` 表
- 通过 `AuditLogMiddleware.Handler()` 在受保护路由组挂载

掌握上述中间件后，可自定义请求链路或扩展新的横切关注点。