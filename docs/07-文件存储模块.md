# 文件存储模块

## 组件概览
- 服务：`internal/service/file_service.go`
- 仓储：`internal/repository/file_repository.go`
- HTTP 接口：`internal/handler/file_handler.go`
- 数据模型：`internal/model/file.go`
- 存储抽象：`pkg/storage/storage.go`
- 本地实现：`pkg/storage/local.go`
- 配置来源：`config.upload`（见 `pkg/config/config.go`）

## 功能总览
- 上传：校验文件类型/大小、生成唯一文件名、按分类与日期组织目录。
- 秒传：上传前计算 SHA256，复用已有物理文件并新增元数据记录。
- 缩略图：图片支持自动生成缩略图并回写尺寸信息。
- 下载：仅允许上传者（或待扩展的管理员）访问，支持流式输出。
- 删除：逻辑删除数据库记录，物理文件由后续清理策略处理。
- 查询：按用户、分类、关键词检索，提供分页与空间占用统计。

## 上传流程
1. `FileHandler.Upload` 从表单读取文件和 `category`（默认为 `other`），获取当前用户 ID。
2. `fileService.Upload` 执行以下步骤：
   - `validateFile` 根据配置校验最大体积、白名单扩展名与 MIME 类型。
   - 打开文件并 `calculateHash`，命中已有记录时仅复制元数据（实现秒传）。
   - 生成 `uuid + 扩展名` 的保存名，并按 `分类/年/月/日` 生成路径。
   - 调用存储实现（默认 `LocalStorage`）写入文件并返回访问 URL。
   - 若为图片，`processImage` 负责解析尺寸和可选缩略图（依赖 `nfnt/resize`）。
   - 写入 `files` 表，失败时回滚存储层已上传的文件。
3. 返回 `FileResponse`，包含原始名称、URL、缩略图、尺寸信息等。

### 头像上传
`/api/v1/files/upload/avatar` 复用通用上传逻辑，额外限制扩展名为图片类型，分类固定为 `avatar`，便于前端直接更新头像。

## 存储适配
- 所有存储实现需满足 `storage.Storage` 接口（上传、下载、删除、取 URL 等）。
- 默认实现：`LocalStorage`
  - 构造函数 `NewLocalStorage` 确保基础目录存在。
  - `Upload` 会创建目标目录并写入文件。
  - `GetURL` 按 `<baseURL>/<path>` 返回可访问地址，配合 Echo 静态目录 `/uploads` 直接访问本地文件。
- 若需接入 OSS/S3 等云存储，可在此目录新增实现并在配置中切换 `storage_type`。

## 下载与权限
- `FileHandler.Download` 将 ID 和当前用户传入 `fileService.Download`。
- 服务层校验文件是否存在且 `uploaded_by == userID`。
- 验证通过后调用存储层的 `Download`，设置响应头返回流式数据。
- TODO 注释提示可扩展管理员越权下载逻辑。

## 删除策略
- 删除接口仅检查当前用户拥有文件。
- 仓储层 `Delete` 调用底层泛型仓储执行业务标记（当前为软删）。
- 物理文件保留以支持多条记录引用，相应的垃圾文件可结合定时任务扫描 `files` 表后清理。

## 列表与搜索
- `List` 支持按分类过滤并分页；`Search` 通过关键字模糊匹配 `original_name`、`saved_name`。
- `GetStorageInfo` 统计个人文件数量与空间占用（字节/MB），便于用户界面展示额度。
- 仓储层方法：
  - `ListByUser/ListByCategory` 利用通用分页查询封装。
  - `Search` 手写 GORM 查询以支持统计与排序。
  - `CountByUser`、`GetUserStorageUsage` 提供轻量统计能力。

## 配置项
关键配置位于 `config.upload`：
- `storage_type`：`local`、`oss`、`s3` 等。
- `max_size`、`allowed_types`、`allowed_exts`：上传约束。
- 缩略图开关与大小：`enable_thumbnail`、`thumbnail_width/height/quality`。
- 本地路径与访问地址：`local_path`、`local_url`。
- 云存储凭证：`oss_*` / `s3_*` 等字段用于后续扩展。

## 常见扩展
1. **统一鉴权**：结合 RBAC 在服务层判断角色是否允许跨用户下载/删除。
2. **内容安全**：上传后调用第三方检测（如图片敏感内容识别）更新文件状态。
3. **生命周期管理**：新增定时任务扫描逻辑删除且无人引用的文件，并删除物理对象。
4. **断点续传/分片上传**：在存储接口上层维护分片记录，再合并写入完整文件。
5. **CDN 加速**：为云存储实现增加自定义域名，前端直接使用 `GetURL` 返回的 CDN 地址。

掌握该模块即可完成文件的上传、存储、查询与基本安全控制，并为后续扩展云存储或审核流程提供基础。