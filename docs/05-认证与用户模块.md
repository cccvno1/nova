# 认证与用户模块

## 组件概览
- 用户服务：`internal/service/user_service.go`
- 用户接口：`internal/handler/user_handler.go`
- 认证接口：`internal/handler/auth_handler.go`
- JWT 工具：`pkg/auth/jwt.go`
- Token 黑名单：`pkg/auth/blacklist.go`
- 认证中间件：`pkg/middleware/auth.go`

## JWT 签发
- `auth.JWTAuth` 根据配置生成 Access/Refresh Token
- Claims 字段：`user_id`, `username`, `type`
- Refresh Token 仅用于换取新的 Access Token
- 访问令牌默认 2 小时失效，可在配置中调整

### 签发流程
```go
jwtAuth := auth.NewJWTAuth(&auth.Config{SecretKey: "..."})
tokens, _ := jwtAuth.GenerateTokenPair(user.ID, user.Username)
```

## Token 黑名单
- 目的：
  - 用户主动登出
  - 强制下线（管理员操作）
- 实现：将 token 写入 Redis，TTL 与 token 剩余寿命一致
- 接口：
  - `AddToBlacklist`
  - `IsInBlacklist`
  - `AddUserToBlacklist`
  - `IsUserInBlacklist`

## 认证中间件
- 验证 HTTP 头 `Authorization: Bearer <token>`
- 校验签名与 token 类型
- 拒绝黑名单中的 token 或被强制下线的用户
- 成功后在上下文写入 `user_id`、`username`

## 用户服务
- 创建用户：校验用户名/邮箱是否重复，密码使用 MD5 存储（生产建议替换为 bcrypt）
- 查询：支持分页、单条读取
- 更新：允许修改昵称、头像
- 删除：走 GORM 软删除逻辑（`DeletedAt`），数据仍保留以备追溯
- 注册：创建用户后立即返回 token 对
- 登录：校验密码、状态，返回 token 对
- 刷新：使用 Refresh Token 换取新 Access Token

### 示例：用户注册
```go
req := &service.CreateUserRequest{
    Username: "alice",
    Email:    "alice@example.com",
    Password: "pass123",
}
tokens, err := userService.Register(ctx, req)
```

## HTTP 接口
### 公开接口 `/api/v1/auth`
| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/register` | 注册并返回 token |
| POST | `/login` | 登录并返回 token |
| POST | `/refresh` | 刷新访问令牌 |
| POST | `/logout` | 将当前 token 加入黑名单（需要携带 Access Token） |

### 管理接口 `/api/v1/users`
| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/` | 创建用户 |
| GET | `/` | 分页查询用户 |
| GET | `/:id` | 获取详情 |
| PUT | `/:id` | 更新昵称/头像 |
| DELETE | `/:id` | 删除用户 |

## 常见扩展
- 密码策略：将 `hashPassword` 替换为更安全算法
- 单点登录：在黑名单中增加客户端维度
- 多因子认证：在 `Login` 前增加额外验证

掌握本模块后，可快速搭建登录/注册流程并维护用户信息。