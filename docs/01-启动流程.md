# 启动流程

## 启动入口
- 入口文件：`cmd/server/main.go`
- 通过 `-config` 读取外部配置，默认加载 `configs/config.yaml`

### 初始化顺序
1. 加载配置：`config.Load`
2. 初始化日志：`logger.Init`
3. 初始化数据库：`database.Init` + `defer database.Close()`
4. 初始化 Redis：`cache.Init` + `defer cache.Close()`
5. 自动迁移模型：`database.AutoMigrate`
6. 创建 Casbin Enforcer：`casbin.NewEnforcer`
7. 创建 JWT 服务与黑名单：`auth.NewJWTAuth` + `auth.NewTokenBlacklist`
8. 如果启用队列：`queue.NewWorker` 并启动 Worker
9. 启动调度器：`scheduler.NewScheduler`
10. 创建 Echo Server：`server.New`
11. 装配路由：`router.Setup`
12. 启动 HTTP 服务：`server.Start`

## Server 结构
- 文件：`internal/server/server.go`
- 自定义 `Server` 封装 Echo，负责：
  - 挂载通用中间件：恢复、日志、CORS
  - 使用自定义校验器 `pkg/validator`
  - 使用统一错误处理器 `pkg/middleware.ErrorHandler`
  - 优雅退出：捕获 SIGINT/SIGTERM，10s 超时内关闭

## 路由装配
- 文件：`internal/router/router.go`
- 关键职责：
  - 注册 Swagger UI：`/swagger/*`
  - 创建 Handler、Service、Repository 组合
  - 组装中间件：认证、限流、审计
  - 注册静态资源 `/uploads`

### 路由层级
```
/api
  /v1
    public: 健康检查、Ping、认证接口
    auth: JWT + 用户限流 + 审计日志
      /users            用户管理
      /roles            角色管理
      /permissions      权限管理
      /user-roles       用户角色映射
      /files            文件管理
      /tasks            异步任务查询
      /audit-logs       审计日志查询
```

## 运行时依赖
- 数据库：通过 `database.GetDB()` 在 Router 中复用
- 文件存储：当前默认 `storage.NewLocalStorage`
- 审计中间件：`middleware.NewAuditLogMiddleware`

## 关闭流程
- HTTP 退出触发时：
  - 停止调度器 `scheduler.Stop`
  - 停止队列 Worker（如启用）
  - 关闭 Casbin Enforcer、Redis、数据库连接

掌握上述流程后，即可快速定位服务启动阶段的任一问题。