# 🔒 RBAC 安全加固实施总结

## 📋 项目概述

本次安全加固旨在防止低等级用户越权操作高等级角色，实现了基于**角色等级（Role Level）**的权限管理机制。

---

## ✅ 已完成的工作

### 1. 数据库层改造

#### 1.1 添加等级字段
```sql
ALTER TABLE roles ADD COLUMN level INT NOT NULL DEFAULT 10;
CREATE INDEX idx_roles_level ON roles(level);
```

#### 1.2 初始化等级数据
```sql
UPDATE roles SET level = 100 WHERE name = 'super_admin';  -- 超级管理员
UPDATE roles SET level = 80  WHERE name = 'admin';         -- 管理员
UPDATE roles SET level = 10  WHERE name = 'editor';        -- 编辑者
UPDATE roles SET level = 10  WHERE name = 'viewer';        -- 查看者
```

**验证结果**：
```
 id |    name     | display_name | level 
----+-------------+--------------+-------
  1 | super_admin | 超级管理员   |   100
  2 | admin       | 管理员       |    80
  3 | editor      | 编辑者       |    10
  4 | viewer      | 查看者       |    10
```

### 2. 模型层更新

**文件**: `internal/model/role.go`

```go
type Role struct {
    database.Model
    Name        string `json:"name" gorm:"size:100;not null;uniqueIndex:idx_role_domain"`
    DisplayName string `json:"display_name" gorm:"size:100;not null"`
    Description string `json:"description" gorm:"size:500"`
    Domain      string `json:"domain" gorm:"size:100;not null;uniqueIndex:idx_role_domain;index"`
    Category    string `json:"category" gorm:"size:50"`
    IsSystem    bool   `json:"is_system" gorm:"default:false;index"`
    Level       int    `json:"level" gorm:"default:10;index"`  // ✅ 新增字段
    Sort        int    `json:"sort" gorm:"default:0"`
    Status      int8   `json:"status" gorm:"default:1;index"`
    
    Permissions []Permission `json:"permissions,omitempty" gorm:"many2many:role_permissions;"`
}
```

### 3. Service 层安全检查

**文件**: `internal/service/rbac_service.go`

#### 3.1 核心安全方法

```go
// GetUserMaxRoleLevel - 获取用户在指定域下的最高角色等级
func (s *rbacService) GetUserMaxRoleLevel(ctx context.Context, userID uint, domain string) (int, error)

// CheckRoleLevelPermission - 检查用户是否有权限操作指定等级的角色
func (s *rbacService) CheckRoleLevelPermission(ctx context.Context, operatorID uint, targetRoleID uint, domain string) error

// CheckRolesLevelPermission - 批量检查用户是否有权限操作指定的多个角色
func (s *rbacService) CheckRolesLevelPermission(ctx context.Context, operatorID uint, targetRoleIDs []uint, domain string) error
```

#### 3.2 行级安全（Row Level Security）

```go
// ListRolesFiltered - 列出角色（带权限过滤）
// 自动过滤高等级角色，低等级用户查询时不会看到高等级角色
func (s *rbacService) ListRolesFiltered(ctx context.Context, operatorID uint, domain string, pagination *database.Pagination) ([]model.Role, error) {
    operatorLevel, err := s.GetUserMaxRoleLevel(ctx, operatorID, domain)
    if err != nil {
        return nil, err
    }
    
    roles, err := s.roleRepo.List(ctx, domain, pagination)
    if err != nil {
        return nil, err
    }
    
    // 只返回等级严格低于操作者的角色
    filteredRoles := make([]model.Role, 0)
    for _, role := range roles {
        if role.Level < operatorLevel {
            filteredRoles = append(filteredRoles, role)
        }
    }
    
    return filteredRoles, nil
}

// SearchRolesFiltered - 搜索角色（带权限过滤）
func (s *rbacService) SearchRolesFiltered(ctx context.Context, operatorID uint, keyword, domain string, pagination *database.Pagination) ([]model.Role, error)
```

### 4. Handler 层权限验证

**文件**: `internal/handler/role_handler.go` 和 `user_role_handler.go`

#### 4.1 角色管理操作保护

```go
// UpdateRole - 修改角色
func (h *RoleHandler) UpdateRole(c echo.Context) error {
    // ... 获取角色 ...
    
    // 🔒 安全检查：只能修改比自己等级低的角色
    if operatorID, ok := c.Get("user_id").(uint); ok && operatorID > 0 {
        if err := h.rbacService.CheckRoleLevelPermission(c.Request().Context(), operatorID, uint(id), role.Domain); err != nil {
            return errors.New(errors.ErrForbidden, err.Error())
        }
    }
    
    // ... 执行更新 ...
}

// DeleteRole - 删除角色
// UpdatePermissions - 配置角色权限
// 均添加了相同的等级检查
```

#### 4.2 查询接口行级过滤

```go
// ListRoles - 获取角色列表
func (h *RoleHandler) ListRoles(c echo.Context) error {
    // ... 解析参数 ...
    
    // 🔒 使用带等级过滤的查询，只返回可管理的角色
    var roles []model.Role
    var err error
    
    if operatorID, ok := c.Get("user_id").(uint); ok && operatorID > 0 {
        roles, err = h.rbacService.ListRolesFiltered(c.Request().Context(), operatorID, domain, pagination)
    } else {
        // 如果无法获取用户ID，返回空列表（安全起见）
        roles = []model.Role{}
    }
    
    // ... 返回结果 ...
}

// SearchRoles - 搜索角色（同样使用 SearchRolesFiltered）
```

#### 4.3 用户角色分配保护

```go
// AssignRolesToUser - 给用户分配角色
func (h *UserRoleHandler) AssignRolesToUser(c echo.Context) error {
    // ... 解析参数 ...
    
    operatorID := c.Get("user_id").(uint)
    
    // 🔒 安全检查：只能给用户分配比自己等级低的角色
    if err := h.rbacService.CheckRolesLevelPermission(c.Request().Context(), operatorID, req.RoleIDs, req.Domain); err != nil {
        return errors.New(errors.ErrForbidden, err.Error())
    }
    
    // ... 执行分配 ...
}

// RevokeRolesFromUser - 撤销用户角色（同样添加了检查）
```

---

## 🔒 安全规则说明

### 核心原则
```
操作者等级 > 目标角色等级 （严格大于）
```

### 规则说明

| 操作者等级 | 可操作的角色等级 | 说明 |
|-----------|----------------|------|
| Level 100 | Level 1-99 | 超级管理员可管理所有其他角色 |
| Level 80  | Level 1-79 | 管理员可管理编辑者、查看者等 |
| Level 80  | ❌ Level 80 | **不能操作同等级角色** |
| Level 10  | 无 | 普通用户无法管理任何角色 |

### 为什么不包括同级？

**防止同级用户互相攻击**：
```
场景：两个Level 50的部门经理
- 经理A不能修改经理B的权限
- 经理B也不能修改经理A的权限
- 防止权限争夺和恶意降权
```

---

## 🛡️ 三层防护体系

```
┌─────────────────────────────────────────────────┐
│         查询层防护（行级安全）                    │
│  - ListRolesFiltered: 自动过滤高等级角色         │
│  - SearchRolesFiltered: 搜索时自动过滤           │
│  - 低等级用户查询时看不到高等级角色              │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│         操作层防护（写保护）                      │
│  - UpdateRole: 修改角色信息                      │
│  - DeleteRole: 删除角色                          │
│  - UpdatePermissions: 配置角色权限               │
│  - AssignRolesToUser: 分配角色给用户             │
│  - RevokeRolesFromUser: 撤销用户角色             │
└─────────────────────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────┐
│         数据层基础（Level 字段）                  │
│  - 存储角色等级(1-100)                           │
│  - 索引优化快速比较                              │
│  - 迁移脚本初始化数据                            │
└─────────────────────────────────────────────────┘
```

---

## 📝 错误消息示例

### 修改高等级角色
```json
{
  "code": 403,
  "message": "权限不足：无法操作等级为 100 的角色（您的等级为 80），只能管理比您等级低的角色"
}
```

### 分配高等级角色
```json
{
  "code": 403,
  "message": "权限不足：无法分配等级为 100 的角色 '超级管理员'（您的等级为 80），只能分配比您等级低的角色"
}
```

---

## ⚠️ 已知问题

### 1. API响应缺少level字段

**问题描述**：
虽然数据库中有level字段，且Go模型中有JSON标签，但API返回的JSON中不包含level字段。

**当前状态**：
```json
// 实际返回（缺少level）
{
  "id": 1,
  "name": "super_admin",
  "display_name": "超级管理员"
  // ❌ 缺少 "level": 100
}

// 期望返回
{
  "id": 1,
  "name": "super_admin",
  "display_name": "超级管理员",
  "level": 100  // ✅ 应该包含
}
```

**可能原因**：
1. Docker镜像使用了旧的缓存代码
2. GORM查询时Select字段过滤
3. 中间件或序列化层过滤

**修复方案**：
- ✅ 正在执行：重新构建Docker镜像（--no-cache）
- 待验证：重启服务后测试API响应

### 2. 前端未显示等级列

**问题描述**：
角色管理页面的表格中没有显示等级列和等级徽章。

**原因**：
依赖于API返回level字段，当前API未返回此数据。

**待实现**：
```vue
<el-table-column prop="level" label="等级" width="100" align="center">
  <template #default="{ row }">
    <el-tag :type="getLevelTagType(row.level)" effect="dark">
      Level {{ row.level }}
    </el-tag>
  </template>
</el-table-column>
```

---

## 🚀 下一步计划

### 短期（待API修复后）

1. **验证API响应**
   - [ ] 确认API返回包含level字段
   - [ ] 测试不同等级用户的查询结果

2. **前端UI增强**
   - [ ] 添加等级列到角色表格
   - [ ] 显示彩色等级徽章
   - [ ] 根据等级禁用操作按钮
   - [ ] 添加等级说明工具提示

3. **完整测试**
   - [ ] 创建Level 80测试用户
   - [ ] 验证行级安全过滤
   - [ ] 验证操作层权限检查
   - [ ] 验证错误消息友好性

### 中期（功能完善）

4. **性能优化**
   - [ ] 缓存用户最高等级
   - [ ] 数据库层WHERE过滤（替代应用层过滤）
   - [ ] 添加等级比较的数据库索引优化

5. **审计增强**
   - [ ] 记录所有等级检查失败的尝试
   - [ ] 监控异常的越权操作
   - [ ] 定期审查高等级角色操作日志

### 长期（安全加固）

6. **安全审查**
   - [ ] 代码审计（查找绕过漏洞）
   - [ ] 渗透测试
   - [ ] 定期角色等级审查

7. **文档完善**
   - [ ] 管理员操作手册
   - [ ] 安全最佳实践
   - [ ] 故障排查指南

---

## 📚 参考实现

本实施方案参考了以下业界标准：

- **PostgreSQL Row Level Security (RLS)**
  - 数据库层面的行级过滤
  - 自动应用安全策略

- **Apache Ranger**
  - 统一的权限管理框架
  - 基于策略的访问控制

- **Casbin RBAC**
  - 灵活的权限模型
  - 支持角色继承和层级

- **AWS IAM Permission Boundaries**
  - 权限边界限制
  - 防止权限升级

---

## ✅ 安全检查清单

- [x] 数据库level字段已添加
- [x] 数据库数据已初始化
- [x] Go模型已更新
- [x] Service层安全方法已实现
- [x] Handler层权限检查已添加
- [x] 查询接口行级过滤已实现
- [x] 用户角色分配检查已添加
- [ ] API响应包含level字段（待验证）
- [ ] 前端等级显示已实现（待开发）
- [ ] 完整功能测试已通过（待执行）

---

## 📞 支持与反馈

如有问题或建议，请参考：
- `/docs/11-安全加固测试.md` - 详细测试文档
- GitHub Issues - 提交bug报告

**当前构建状态**：🔄 正在重新构建Docker镜像（无缓存模式）

---

**文档版本**：v1.0
**最后更新**：2025-10-17
**作者**：System Administrator
