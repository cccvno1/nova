# 数据与仓储

## 数据库初始化
- 包位置：`pkg/database`
- 当前实现使用 GORM 连接 PostgreSQL；暂未提供 MySQL 支持，如需接入需自行扩展驱动与初始化逻辑。
- 配置：
  - `SkipDefaultTransaction = true`
  - `PrepareStmt = true`
  - 自定义 `NowFunc` 返回 UTC
  - 连接池：`MaxIdle`, `MaxOpen`, `ConnMaxLifetime`
- `database.Init` 在启动时调用，`database.Close` 在退出时释放

## 通用模型
- `database.Model`：提供 `ID`, `CreatedAt`, `UpdatedAt`, 软删除
- `database.Pagination`：
  - 字段：`page`, `page_size`, `total`
  - 方法：`GetOffset`, `GetLimit`, `Paginate`

## 通用仓储
- `database.Repository[T]`：泛型 CRUD 封装
  - `Create / Update / Delete`
  - `FindByID / FindOne / FindByCondition`
  - `FindWithPagination`
  - `Count / Exists`
  - `Transaction`
- 使用方式：在业务仓储中组合 `database.NewRepository[T](db)`

## 缓存装饰器
- 文件：`internal/repository/base.go`
- `WithCache` 装饰基础仓储，支持：
  - 按 ID 缓存读操作
  - 写操作自动失效缓存
  - 缓存键前缀自定义
- 默认写操作异步清理缓存，避免脏读

## 模型汇总
- `internal/model/user.go`
- `internal/model/role.go`
- `internal/model/permission.go`
- `internal/model/file.go`
- `internal/model/task.go`
- `internal/model/audit_log.go`
- 自动迁移在启动时统一执行

### 示例：用户模型
```go
type User struct {
    database.Model
    Username string `gorm:"uniqueIndex;not null"`
    Email    string `gorm:"uniqueIndex;not null"`
    Password string `gorm:"not null"`
    Status   int    `gorm:"default:1"`
}
```

## 业务仓储示例
### 用户仓储
- 文件：`internal/repository/user_repository.go`
- 特性：
  - 可选缓存（TTL 30 分钟）
  - 额外方法：`FindByUsername`, `ExistsByEmail`, `UpdateStatus`

### 文件仓储
- 文件：`internal/repository/file_repository.go`
- 关键方法：
  - `FindByHash`：支持秒传
  - `Search`：模糊搜索文件名
  - `GetUserStorageUsage`：统计使用量

## 事务支持
- 使用 `database.WithTransaction` 或 `Repository.Transaction`
- 建议在 Service 层组合多个仓储操作时使用

掌握数据层的封装方式，可在保持一致性的同时快速扩展新的实体和仓储逻辑。